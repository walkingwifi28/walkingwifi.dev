---
import githubIcon from "../assets/icons/github-mark.svg";
import githubIconWhite from "../assets/icons/github-mark-white.svg";

const siteName = "walkingwifi.dev";
---

<header
    id="main-header"
    class="p-4 sticky top-0 z-50 w-full transition-all duration-500 ease-in-out"
>
    <div
        class="flex mx-auto items-center justify-between gap-6 w-max px-6 py-4 rounded-full bg-[var(--color-header-bg)]/95 backdrop-blur-lg shadow-md border border-[var(--color-border)] transition-all duration-300"
    >
        <a
            href="/"
            class="text-lg font-semibold tracking-wide text-[var(--color-text)] no-underline hover:opacity-70 transition-opacity duration-300"
        >
            {siteName}
        </a>
        <div class="flex items-center gap-4">
            <button
                id="theme-toggle"
                class="hover:opacity-70 transition-opacity duration-300 cursor-pointer text-[var(--color-text)]"
                aria-label="Toggle dark mode"
            >
                <!-- Sun icon (shown in light mode) -->
                <svg
                    id="theme-icon-light"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 512 512"
                    fill="currentColor"
                    width="18"
                    height="18"
                >
                    <ellipse cx="256" cy="256" rx="137.275" ry="137.28"
                    ></ellipse>
                    <rect x="241.16" width="29.68" height="81.62"></rect>
                    <rect x="241.16" y="430.38" width="29.68" height="81.62"
                    ></rect>
                    <polygon
                        points="181.665,97.56 140.855,26.88 115.15,41.72 155.96,112.41"
                    ></polygon>
                    <rect
                        x="322.784"
                        y="427.522"
                        transform="matrix(-0.5001 -0.866 0.866 -0.5001 162.3364 978.4368)"
                        width="81.618"
                        height="29.677"></rect>
                    <polygon
                        points="26.88,140.85 97.565,181.66 112.41,155.96 41.72,115.15"
                    ></polygon>
                    <polygon
                        points="399.594,356.04 470.285,396.85 485.125,371.15 414.435,330.34"
                    ></polygon>
                    <rect y="241.16" width="81.625" height="29.68"></rect>
                    <rect x="430.375" y="241.16" width="81.625" height="29.68"
                    ></rect>
                    <polygon
                        points="26.88,371.14 41.72,396.85 112.406,356.04 97.565,330.33"
                    ></polygon>
                    <polygon
                        points="485.125,140.85 470.285,115.15 399.594,155.96 414.435,181.66"
                    ></polygon>
                    <rect
                        x="133.566"
                        y="401.543"
                        transform="matrix(-0.866 -0.5 0.5 -0.866 55.7691 899.6527)"
                        width="29.682"
                        height="81.624"></rect>
                    <polygon
                        points="330.335,97.56 356.04,112.41 396.85,41.72 371.15,26.88"
                    ></polygon>
                </svg>
                <!-- Moon icon (shown in dark mode) -->
                <svg
                    id="theme-icon-dark"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 512 512"
                    fill="currentColor"
                    width="18"
                    height="18"
                    class="hidden"
                >
                    <polygon
                        points="100.704,270.59 134.681,252.713 168.721,270.59 162.236,232.711 189.75,205.906 151.701,200.329 134.681,165.862 117.723,200.329 79.675,205.906 107.169,232.711"
                    ></polygon>
                    <polygon
                        points="157.208,82.033 183.824,68.037 210.48,82.033 205.392,52.364 226.96,31.375 197.152,26.995 183.824,0 170.536,26.995 140.747,31.375 162.275,52.364"
                    ></polygon>
                    <polygon
                        points="21.733,120.54 43.362,109.168 65.009,120.54 60.879,96.439 78.397,79.379 54.176,75.828 43.362,53.89 32.547,75.828 8.345,79.379 25.843,96.439"
                    ></polygon>
                    <path
                        d="M330.87,24.092c16.401,32.034,25.918,68.267,25.918,106.734c0,129.389-104.848,234.277-234.237,234.277c-38.507,0-74.74-9.478-106.802-25.957C48.329,439.414,142.423,512,253.556,512c138.108,0,250.099-111.991,250.099-250.1C503.655,150.778,431.129,56.654,330.87,24.092z"
                    ></path>
                </svg>
            </button>
            <a
                href="https://github.com/walkingwifi28/walkingwifi.dev"
                target="_blank"
                rel="noopener noreferrer"
                class="hover:opacity-70 transition-opacity duration-300"
                aria-label="GitHub Repository"
            >
                <img
                    id="github-icon-light"
                    src={githubIcon.src}
                    alt="GitHub"
                    width="18"
                    height="18"
                />
                <img
                    id="github-icon-dark"
                    src={githubIconWhite.src}
                    alt="GitHub"
                    width="18"
                    height="18"
                    class="hidden"
                />
            </a>
        </div>
    </div>
</header>

<script>
    const header = document.getElementById("main-header");
    const themeToggle = document.getElementById("theme-toggle");
    const iconLight = document.getElementById("theme-icon-light");
    const iconDark = document.getElementById("theme-icon-dark");
    const githubIconLight = document.getElementById("github-icon-light");
    const githubIconDark = document.getElementById("github-icon-dark");

    // Theme toggle functionality
    const updateThemeIcons = () => {
        const isDark = document.documentElement.classList.contains("dark");
        if (iconLight && iconDark) {
            iconLight.classList.toggle("hidden", isDark);
            iconDark.classList.toggle("hidden", !isDark);
        }
        if (githubIconLight && githubIconDark) {
            githubIconLight.classList.toggle("hidden", isDark);
            githubIconDark.classList.toggle("hidden", !isDark);
        }
    };

    if (themeToggle) {
        themeToggle.addEventListener("click", async (e) => {
            // Get the button's position for the animation origin
            const rect = themeToggle.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top + rect.height / 2;

            // Calculate the maximum radius needed to cover the entire screen
            const maxRadius = Math.hypot(
                Math.max(x, window.innerWidth - x),
                Math.max(y, window.innerHeight - y),
            );

            // Check if View Transitions API is supported
            if (document.startViewTransition) {
                document.startViewTransition(() => {
                    const isDark =
                        document.documentElement.classList.toggle("dark");
                    localStorage.setItem("theme", isDark ? "dark" : "light");
                    updateThemeIcons();
                });

                // Set custom properties for the animation origin
                document.documentElement.style.setProperty(
                    "--theme-toggle-x",
                    `${x}px`,
                );
                document.documentElement.style.setProperty(
                    "--theme-toggle-y",
                    `${y}px`,
                );
                document.documentElement.style.setProperty(
                    "--theme-toggle-radius",
                    `${maxRadius}px`,
                );
            } else {
                // Fallback for browsers without View Transitions API
                const isDark =
                    document.documentElement.classList.toggle("dark");
                localStorage.setItem("theme", isDark ? "dark" : "light");
                updateThemeIcons();
            }
        });
    }

    // Initialize icons based on current theme
    updateThemeIcons();

    // Header scroll behavior
    if (header) {
        const headerHeight = header.offsetHeight;
        const scrollThreshold = 16; // 約1行分のスクロール量
        let scrollAnchor = window.scrollY; // スクロール方向が変わった時の基準点
        let lastScrollY = window.scrollY;
        let scrollDirection = 0; // 1: down, -1: up, 0: initial
        let isHidden = false;

        const hideHeader = () => {
            if (!isHidden) {
                header.classList.add(
                    "opacity-0",
                    "-translate-y-full",
                    "pointer-events-none",
                );
                isHidden = true;
            }
        };

        const showHeader = () => {
            if (isHidden) {
                header.classList.remove(
                    "opacity-0",
                    "-translate-y-full",
                    "pointer-events-none",
                );
                isHidden = false;
            }
        };

        const handleScroll = () => {
            const currentScrollY = window.scrollY;
            const instantDelta = currentScrollY - lastScrollY;
            const newDirection =
                instantDelta > 0 ? 1 : instantDelta < 0 ? -1 : scrollDirection;

            // スクロール方向が変わったら基準点をリセット
            if (newDirection !== scrollDirection && newDirection !== 0) {
                scrollAnchor = lastScrollY;
                scrollDirection = newDirection;
            }

            const cumulativeDelta = currentScrollY - scrollAnchor;

            // ページ上部では常に表示
            if (currentScrollY <= headerHeight) {
                showHeader();
            }
            // 上方向に累積スクロール（scrollThreshold以上）で表示
            else if (cumulativeDelta < -scrollThreshold) {
                showHeader();
            }
            // 下方向にスクロールで隠す（即座に）
            else if (scrollDirection === 1 && currentScrollY > headerHeight) {
                hideHeader();
            }

            lastScrollY = currentScrollY;
        };

        window.addEventListener("scroll", handleScroll);
        // 初期状態をチェック
        handleScroll();
    }
</script>
