---
import Layout from "../../layouts/Layout.astro";
import { getCollection, render, getEntry } from "astro:content";
import CalendarIcon from "../../components/icons/CalendarIcon.astro";
import RefreshIcon from "../../components/icons/RefreshIcon.astro";
import Tag from "../../components/Tag.astro";

// 全ブログ記事のパスを生成
export async function getStaticPaths() {
    const blogs = await getCollection("blogs");
    return blogs.map((blog) => ({
        params: { slug: blog.id.replace(/\.md$/, "") },
        props: { blog },
    }));
}

const { blog } = Astro.props;

// フロントマターから日付を取得
const createdAt = blog.data.createdAt;
const updatedAt = blog.data.updatedAt;

const { Content } = await render(blog);

// タグ情報を取得（存在しないタグはスキップ）

// TinaCMS のパス形式 "src/content/tags/xxx.md" から ID を抽出
const extractTagId = (tagPath: string) => {
    const match = tagPath.match(/src\/content\/tags\/(.+)\.md$/);
    return match ? match[1] : null;
};

const tagPaths = blog.data.tags?.map((t) => t.tag) || [];
const tagPromises = tagPaths.map(async (tagPath) => {
    const tagId = extractTagId(tagPath);
    if (!tagId) return null;
    try {
        const entry = await getEntry("tags", tagId);
        return entry;
    } catch {
        return null;
    }
});

const rawTags = await Promise.all(tagPromises);
const tags = rawTags.filter((t) => t !== null);

// 存在しないタグを検出
const missingTagCount = tagPaths.length - tags.length;
const hasMissingTags = missingTagCount > 0;

// 日付フォーマット（YYYY.MM.DD）- UTC日付をそのまま使用
const formatDate = (date: Date | undefined): string => {
    if (!date) return "";
    const year = date.getUTCFullYear();
    const month = String(date.getUTCMonth() + 1).padStart(2, "0");
    const day = String(date.getUTCDate()).padStart(2, "0");
    return `${year}.${month}.${day}`;
};

const ogpImagePath = `/ogp/${blog.id.replace(/\.md$/, "")}.png`;
---

<Layout
    title={blog.data.title}
    description={blog.data.description}
    image={ogpImagePath}
>
    <main class="max-w-6xl mx-auto px-4 py-8">
        {
            blog.data.thumbnail && (
                <div class="mb-8 rounded-2xl overflow-hidden shadow-lg aspect-video">
                    <img
                        src={blog.data.thumbnail}
                        alt={blog.data.title}
                        class="w-full h-full object-cover"
                    />
                </div>
            )
        }

        <!-- タイトル -->
        <h1
            class="text-4xl font-bold text-[var(--color-text)] mb-4 leading-tight"
        >
            {blog.data.title}
        </h1>

        <!-- 日付情報 -->
        <div
            class="flex items-center gap-6 text-[var(--color-text-secondary)] text-sm mb-4"
        >
            <!-- 作成日 -->
            {
                createdAt && (
                    <div class="flex items-center gap-1.5">
                        <CalendarIcon />
                        <span>{formatDate(createdAt)}</span>
                    </div>
                )
            }
            <!-- 更新日 -->
            {
                updatedAt && (
                    <div class="flex items-center gap-1.5">
                        <RefreshIcon />
                        <span>{formatDate(updatedAt)}</span>
                    </div>
                )
            }
        </div>

        <!-- タグ -->
        {
            tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mb-6">
                    {tags.map((t) => (
                        <Tag name={t.data.name} />
                    ))}
                </div>
            )
        }

        <div class="post mt-8 leading-relaxed">
            <Content />
        </div>
    </main>
</Layout>
